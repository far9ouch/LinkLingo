<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LinkLingo - Chat</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
  <link rel="stylesheet" href="./style.css">
  <link rel="stylesheet" href="./chat.css">
  <!-- Update to latest Firebase version -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getDatabase, ref, push, onValue, set, remove } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBt8s3bEQYaOJzmgBtUrm0ZkkjVNNo2OIE",
      authDomain: "linklingo-b9661.firebaseapp.com",
      projectId: "linklingo-b9661",
      storageBucket: "linklingo-b9661.firebasestorage.app",
      messagingSenderId: "21280895713",
      appId: "1:21280895713:web:138671c7881419bc12fda0",
      databaseURL: "https://linklingo-b9661-default-rtdb.firebaseio.com"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get or create user ID and name from cookies
    let currentUserId = getCookie('userId');
    let username = getCookie('username');
    if (!currentUserId || !username) {
      currentUserId = Math.random().toString(36).substring(2);
      username = 'User_' + Math.random().toString(36).substring(2, 6);
      setCookie('userId', currentUserId, 365);
      setCookie('username', username, 365);
    }

    // Track online users
    const userStatusRef = ref(db, 'status/' + currentUserId);
    set(userStatusRef, {
      online: true,
      username: username,
      timestamp: Date.now()
    });

    // Remove user status on disconnect
    window.addEventListener('beforeunload', () => {
      remove(userStatusRef);
    });

    // Count online users
    const statusRef = ref(db, 'status');
    onValue(statusRef, (snapshot) => {
      const onlineUsers = snapshot.val() || {};
      const count = Object.keys(onlineUsers).length;
      document.querySelector('.online-count').textContent = count + ' online';
    });

    let partnerId = null;
    let currentChatId = null;
    let skipCount = 0;
    const maxSkips = 3;
    let isConnected = false;
    let skipClickCount = 0;

    function findNewChat() {
      const waitingRef = ref(db, 'waiting');
      remove(ref(db, `waiting/${currentUserId}`));

      onValue(waitingRef, async (snapshot) => {
        if (isConnected) return;
        
        const waitingUsers = snapshot.val() || {};
        const waitingIds = Object.keys(waitingUsers)
          .filter(id => id !== currentUserId);
        
        if (waitingIds.length > 0) {
          partnerId = waitingIds[0];
          currentChatId = Math.random().toString(36).substring(2);
          
          await set(ref(db, `chats/${currentChatId}`), {
            users: {
              [currentUserId]: username,
              [partnerId]: waitingUsers[partnerId].username
            },
            messages: []
          });
          
          await remove(ref(db, `waiting/${partnerId}`));
          enableChat();
          listenToMessages(currentChatId);
        } else {
          await set(ref(db, `waiting/${currentUserId}`), {
            username: username,
            timestamp: Date.now()
          });
        }
      });
    }

    function enableChat() {
      isConnected = true;
      document.querySelector('.status').innerHTML = `
        <span class="status-dot" style="background: #00ff00"></span>
        Connected
      `;
      document.querySelector('input').disabled = false;
      document.querySelector('.send-btn').disabled = false;
      document.querySelector('.skip-btn').disabled = false;
    }

    function updateChatMessages(messages) {
      const chatMessages = document.querySelector('.chat-messages');
      chatMessages.innerHTML = '';
      
      Object.values(messages).forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${msg.sender === currentUserId ? 'sent' : 'received'}`;
        messageDiv.textContent = msg.text;
        chatMessages.appendChild(messageDiv);
      });
      
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Handle send/skip button
    document.querySelector('.send-btn').addEventListener('click', () => {
      if (!isConnected) return;

      const input = document.querySelector('input');
      const message = input.value.trim();
      
      if (message && currentChatId) {
        skipClickCount = 0; // Reset skip count when sending message
        const messagesRef = ref(db, `chats/${currentChatId}/messages`);
        push(messagesRef, {
          text: message,
          sender: currentUserId,
          username: username,
          timestamp: Date.now()
        });
        input.value = '';
      } else {
        skipClickCount++;
        if (skipClickCount >= 3) {
          skipChat();
          skipClickCount = 0;
        }
      }
    });

    // Enter key to send
    document.querySelector('input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.querySelector('.send-btn').click();
      }
    });

    function skipChat() {
      if (skipCount >= maxSkips) {
        alert('You have reached the maximum number of skips. Please wait a moment.');
        return;
      }
      
      skipCount++;
      isConnected = false;
      if (currentChatId) {
        remove(ref(db, `chats/${currentChatId}`));
      }
      currentChatId = null;
      partnerId = null;
      
      resetChatUI();
      findNewChat();
    }

    function resetChatUI() {
      document.querySelector('.status').innerHTML = `
        <span class="status-dot"></span>
        Looking for stranger...
      `;
      document.querySelector('input').disabled = true;
      document.querySelector('.send-btn').disabled = true;
      document.querySelector('.chat-messages').innerHTML = `
        <div class="system-message">
          Waiting to connect you with someone...
        </div>
      `;
    }

    // Cookie functions
    function setCookie(name, value, days) {
      const expires = new Date(Date.now() + days * 864e5).toUTCString();
      document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/';
    }

    function getCookie(name) {
      return document.cookie.split('; ').reduce((r, v) => {
        const parts = v.split('=');
        return parts[0] === name ? decodeURIComponent(parts[1]) : r;
      }, '');
    }

    // Start chat
    findNewChat();

    // Add user info to footer
    document.querySelector('.user-info').textContent = `ID: ${currentUserId} | Name: ${username}`;
  </script>
</head>
<body class="chat-page">
  <div class="chat-container">
    <div class="chat-header">
      <div class="logo">LinkLingo</div>
      <div class="online-count">0 online</div>
      <div class="status">
        <span class="status-dot"></span>
        Looking for stranger...
      </div>
    </div>
    
    <div class="chat-messages">
      <div class="system-message">
        Waiting to connect you with someone...
      </div>
    </div>

    <div class="chat-input">
      <input type="text" placeholder="Type a message..." disabled>
      <button class="send-btn" disabled>Send/Skip</button>
    </div>

    <div class="chat-footer">
      <div class="user-info"></div>
    </div>
  </div>
</body>
</html> 